<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Orelha dos Sonhos</title>

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://orelha-dos-sonhos.github.io/app/">
    <meta property="og:title" content="Orelha dos Sonhos">
    <meta property="og:image" content="https://orelha-dos-sonhos.github.io/app/banner-orelha.webp">
    
    <link rel="icon" type="image/png" href="icon-web.png">
    <link rel="apple-touch-icon" href="icon-web.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Raleway:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --texto-escuro: #333333;
            --fonte-titulo: 'Playfair Display', serif;
            --fonte-ui: 'Raleway', sans-serif;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            
            --bg-gradient: linear-gradient(180deg, #0B464C 0%, #206870 100%);
            --glass-bg-start: rgba(11, 70, 76, 0.5);
            --glass-bg-end: rgba(15, 85, 90, 0.85);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-shadow: rgba(0, 0, 0, 0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--fonte-ui); color: #f0f0f0;
            height: 100vh; height: 100dvh; width: 100vw; overflow: hidden;
            display: flex; flex-direction: column; align-items: center;
            background: var(--bg-gradient);
            padding-top: var(--safe-top); padding-bottom: 0; 
        }

        #app-container {
            width: 100%; max-width: 600px; height: 100%;
            display: flex; flex-direction: column; position: relative;
            transition: opacity 0.8s ease-in-out;
        }

        /* HEADER & LOGO */
        header { 
            padding: 10px; width: 100%; text-align: center; z-index: 10; flex-shrink: 0;
            background: transparent; height: auto;
        }
        .logo-link { display: inline-block; cursor: pointer; transition: transform 0.2s; }
        .logo-link:active { transform: scale(0.95); }
        .logo-img { 
            height: 55px; width: auto; display: block; margin: 0 auto; 
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3)); 
        }

        /* PALCO (Câmera) */
        #container-palco { 
            flex: 1; display: flex; justify-content: center; align-items: center; 
            padding: 5px 10px; position: relative; overflow: hidden;
        }
        #palco {
            height: 100%; max-height: 100%;
            aspect-ratio: 1080 / 1626; 
            background: #000; border-radius: 18px; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); 
            position: relative; touch-action: none; user-select: none;
        }
        @media (min-aspect-ratio: 1080/1626) { #palco { height: auto; width: 100%; } }
        
        video, #previewImage { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        #previewImage { background: #000; }
        .mirrored { transform: scaleX(-1); }
        #previewImage.cropping-mode { object-fit: contain; cursor: move; }
        
        /* STICKER SEM SOMBRA */
        .sticker-joia {
            position: absolute; width: 100px; top: 50%; left: 50%; 
            cursor: grab; 
            z-index: 15;
            touch-action: none;
        }
        .sticker-joia.selected { border: 1px dashed rgba(255,255,255,0.9); }

        /* CONTROLES E PAINÉIS */
        .ios-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 80%; max-width: 300px; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 40px; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; justify-items: center; z-index: 30; }
        .shutter-button { width: 60px; height: 60px; border-radius: 50%; border: 3px solid white; background: transparent; padding: 2px; cursor: pointer; }
        .shutter-button::after { content: ''; display: block; width: 100%; height: 100%; background: white; border-radius: 50%; }
        .mini-btn { color: #fff; background: transparent; border: none; font-size: 0.6rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; opacity: 0.9; }
        .mini-btn i { font-size: 24px; margin-bottom: 2px; }
        
        #crop-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 350px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border-radius: 20px; padding: 15px; z-index: 35; display: none; flex-direction: column; gap: 15px; color: #333; }
        .crop-header { text-align: center; font-weight: 800; text-transform: uppercase; font-size: 0.8rem; }
        .crop-actions { display: flex; gap: 10px; }
        .btn-crop { flex: 1; padding: 12px; border: none; border-radius: 50px; font-weight: 800; text-transform: uppercase; font-size: 0.75rem; cursor: pointer; }
        .btn-cancel { background: #ff5252; color: white; }
        .btn-confirm { background: var(--texto-escuro); color: white; }
        
        #painel-edicao { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(135deg, var(--glass-bg-start), var(--glass-bg-end)); backdrop-filter: blur(20px); border-top: 1px solid var(--glass-border); border-radius: 25px 25px 0 0; padding: 8px 15px calc(10px + var(--safe-bottom)) 15px; display: none; flex-direction: column; gap: 8px; z-index: 50; box-shadow: 0 -5px 30px rgba(0,0,0,0.3); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); }
        #painel-edicao.minimized { transform: translateY(78%); }
        .conteudo-ocultavel { opacity: 1; transition: opacity 0.2s; display: flex; flex-direction: column; gap: 8px; }
        .header-edicao { display: flex; justify-content: space-between; align-items: center; height: 35px; cursor: pointer; }
        .titulo-edicao { font-weight: 800; color: #fff; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }
        .btn-toggle { background: transparent; border: none; color: #fff; cursor: pointer; display: flex; align-items: center; }
        .btn-voltar-edicao { background: rgba(255,255,255,0.1); border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; }
        
        .carrossel { display: flex; overflow-x: auto; gap: 8px; padding: 2px; min-height: 60px; }
        .thumb-joia { flex-shrink: 0; width: 55px; height: 55px; border-radius: 50%; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5); padding: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; display: none; }
        .thumb-joia.loaded { display: flex; }
        .thumb-joia.active { border-color: #81d4fa; background: rgba(255,255,255,0.4); transform: scale(1.1); }
        .thumb-joia img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
        
        .ferramentas-ajuste { display: flex; gap: 8px; align-items: center; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px; }
        .slider-row { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .slider-label { font-size: 0.55rem; font-weight: 800; text-transform: uppercase; color: #ddd; margin-bottom: 0; }
        input[type=range] { width: 100%; accent-color: #81d4fa; height: 3px; cursor: pointer; }
        .btn-trash { width: 32px; height: 32px; border-radius: 50%; border: none; background: #ff5252; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .acoes-finais { width: 100%; margin-top: 5px; }
        .btn-final { width: 100%; background: linear-gradient(90deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1)); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.4); color: #fff; border-radius: 50px; padding: 15px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .btn-final:active { transform: scale(0.98); background: rgba(255,255,255,0.25); }
        .btn-final.loading::after { content: ""; width: 15px; height: 15px; border: 2px solid white; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }

        /* --- IMPRESSORA REALISTA (SKEUOMORPHISM CLEAN) --- */
        #impressora-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100;
            display: none;
            flex-direction: column; align-items: center; justify-content: flex-start;
            background: rgba(11, 70, 76, 0.95);
        }

        .printer-body {
            width: 105%; height: 150px;
            /* Design Metálico Clean (Sem listras) */
            background: linear-gradient(to bottom, #dcdcdc 0%, #999 40%, #666 100%);
            border-bottom: 12px solid #222;
            box-shadow: 0 15px 40px rgba(0,0,0,0.7);
            position: relative; z-index: 105; /* Acima da foto */
            display: flex; justify-content: center; align-items: flex-end;
            padding-bottom: 25px;
            border-radius: 0 0 15px 15px;
        }

        /* LEDs de Status */
        .led-group { position: absolute; top: 40%; right: 60px; display: flex; gap: 8px; }
        .led { width: 10px; height: 10px; border-radius: 50%; border: 1px solid #444; box-shadow: inset 0 1px 2px rgba(0,0,0,0.5); }
        .led-red { 
            background: #ff0000;
            box-shadow: 0 0 8px #ff0000, inset 0 0 4px #fff;
            animation: blinkFast 0.1s infinite alternate; 
        }
        .led-green { 
            background: #00ff00;
            box-shadow: 0 0 15px #00ff00, 0 0 5px #fff;
        }
        
        @keyframes blinkFast { from { opacity: 0.3; } to { opacity: 1; } }

        /* Slot de Saída Profundo */
        .printer-slot {
            width: 340px; height: 12px;
            background: linear-gradient(to bottom, #000 0%, #333 100%);
            border-radius: 6px;
            box-shadow: inset 0 3px 8px rgba(0,0,0,1), 0 1px 0 rgba(255,255,255,0.3);
            border: 1px solid #111;
            z-index: 106;
        }

        /* Foto Saindo - AJUSTE 90px */
        .photo-container {
            position: absolute;
            top: 90px; /* Dentro da impressora */
            z-index: 100; /* Atrás da impressora */
            width: 300px; height: auto;
            opacity: 0;
            filter: none; /* Sem sombra */
            transform-origin: top center;
        }
        .photo-container img { width: 100%; display: block; border-radius: 2px; }

        /* Animação Lenta (5s) */
        .printing-animation {
            animation: printPhoto 5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        @keyframes printPhoto {
            0% { top: 90px; opacity: 0; transform: scale(0.98); }
            5% { opacity: 1; transform: scale(1); }
            /* FINAL 140px (Ainda mais perto do slot) */
            100% { top: 140px; opacity: 1; transform: scale(1); }
        }

        .btn-share-final {
            margin-top: 20px; width: 280px; position: absolute; bottom: 50px;
            opacity: 0; transition: opacity 1s ease; z-index: 110;
            background: linear-gradient(90deg, var(--glass-bg-start), var(--glass-bg-end));
            backdrop-filter: blur(10px); border: 1px solid var(--glass-border);
            color: #fff; padding: 15px; border-radius: 50px;
            font-weight: 800; text-transform: uppercase; font-size: 1rem;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            cursor: pointer; text-decoration: none;
        }
        .btn-share-final.visible { opacity: 1; }
        #fileInput { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="impressora-overlay">
        <div class="printer-body">
            <div class="led-group">
                <div class="led led-red"></div>
                <div class="led led-green"></div>
            </div>
            <div class="printer-slot"></div>
        </div>
        
        <div class="photo-container" id="photoResult">
            <img id="finalPolaroidImage" src="" alt="Sua Foto">
        </div>

        <button class="btn-share-final" id="btnShareFinal" onclick="compartilharResultado()">
            <i class="material-icons">ios_share</i> Compartilhar
        </button>
        
        <button onclick="location.reload()" style="position:absolute; top:20px; right:20px; background:none; border:none; color:#fff; z-index:120; cursor:pointer;">
            <i class="material-icons">close</i>
        </button>
    </div>

    <div id="app-container">
        <header>
            <a href="index.html" class="logo-link">
                <img src="logo-branco-light.png" alt="Orelha dos Sonhos" class="logo-img">
            </a>
        </header>

        <div id="container-palco">
            <div id="palco">
                <video id="videoElement" autoplay playsinline class="mirrored"></video>
                <img id="previewImage" style="display:none;" crossorigin="anonymous">
                <div id="ios-controls" class="ios-controls">
                    <button class="mini-btn" onclick="document.getElementById('fileInput').click()" title="Galeria"><i class="material-icons">photo_library</i></button>
                    <input type="file" id="fileInput" accept="image/*" onchange="uploadGaleria(event)">
                    <button class="shutter-button" onclick="capturarFoto()"></button>
                    <button class="mini-btn" onclick="alternarCamera()" title="Trocar Câmera"><i class="material-icons">flip_camera_ios</i></button>
                </div>
                <div id="crop-controls">
                    <div class="crop-header">Ajuste a imagem</div>
                     <div class="slider-row"><input type="range" min="0.5" max="3" step="0.01" value="1" id="cropZoomSlider" oninput="atualizarZoomCrop(this.value)"></div>
                    <div class="crop-actions"><button class="btn-crop btn-cancel" onclick="cancelarCrop()">Cancelar</button><button class="btn-crop btn-confirm" onclick="confirmarCrop()">Confirmar</button></div>
                </div>
            </div>
        </div>

        <div id="painel-edicao">
            <div class="header-edicao">
                <div class="titulo-wrapper" onclick="togglePainel()"><button class="btn-toggle"><i class="material-icons" id="iconToggle">expand_more</i></button><span class="titulo-edicao">Personalizar</span></div>
                <button class="btn-voltar-edicao" onclick="resetar()"><i class="material-icons">close</i></button>
            </div>
            <div class="conteudo-ocultavel">
                <div class="carrossel" id="listaJoias"></div>
                <div class="ferramentas-ajuste">
                    <div class="slider-row"><div class="slider-label">Tamanho</div><input type="range" min="30" max="400" value="120" id="rangeSize" oninput="ajustarStickerAtivo()"></div>
                    <div class="slider-row"><div class="slider-label">Rotação</div><input type="range" min="-180" max="180" value="0" id="rangeRotate" oninput="ajustarStickerAtivo()"></div>
                    <button class="btn-trash" onclick="removerStickerAtivo()" title="Remover"><i class="material-icons">delete</i></button>
                </div>
                <div class="acoes-finais">
                    <button class="btn-final" id="btnFinalizar" onclick="animarImpressao()"><span>Finalizar</span> <i class="material-icons">check_circle</i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('videoElement'); const preview = document.getElementById('previewImage'); const palco = document.getElementById('palco'); const listaJoias = document.getElementById('listaJoias'); const rangeSize = document.getElementById('rangeSize'); const rangeRotate = document.getElementById('rangeRotate'); const btnFinalizar = document.getElementById('btnFinalizar'); const painel = document.getElementById('painel-edicao'); const iconToggle = document.getElementById('iconToggle'); const iosControls = document.getElementById('ios-controls'); const cropControls = document.getElementById('crop-controls'); const cropZoomSlider = document.getElementById('cropZoomSlider');
        const impressoraOverlay = document.getElementById('impressora-overlay'); const photoResult = document.getElementById('photoResult'); const finalPolaroidImage = document.getElementById('finalPolaroidImage'); const btnShareFinal = document.getElementById('btnShareFinal'); const appContainer = document.getElementById('app-container');

        let stickerAtivo = null;
        let currentFacingMode = 'environment'; 
        let currentStream = null; let isCroppingMode = false; let cropScale = 1; let cropTranslateX = 0; let cropTranslateY = 0; let isDraggingCrop = false; let startDragCropX, startDragCropY; let blobFinal = null;

        const BASE_WIDTH = 1080; const BASE_HEIGHT = 1626;
        const backupJoias = ["https://raw.githubusercontent.com/Orelha-dos-Sonhos/app/refs/heads/main/logo-miniatura.png", "https://raw.githubusercontent.com/Orelha-dos-Sonhos/app/refs/heads/main/orelha-icon.png"];

        window.onload = () => { startCamera(); carregarCatalogoHibrido(); }

        // --- FUNÇÕES BÁSICAS ---
        async function startCamera() {
            if (currentStream) currentStream.getTracks().forEach(track => track.stop());
            const constraints = { video: { facingMode: currentFacingMode, width: { ideal: 1920 }, height: { ideal: 1080 } } };
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream; video.srcObject = stream;
                if (currentFacingMode === 'user') video.classList.add('mirrored'); else video.classList.remove('mirrored');
            } catch (err) { try { const streamPC = await navigator.mediaDevices.getUserMedia({ video: true }); currentStream = streamPC; video.srcObject = streamPC; video.classList.add('mirrored'); } catch(e) {} }
        }
        function alternarCamera() { currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user'; startCamera(); }
        function capturarFoto() {
            const canvas = document.createElement('canvas'); canvas.width = BASE_WIDTH; canvas.height = BASE_HEIGHT; const ctx = canvas.getContext('2d');
            const vW = video.videoWidth; const vH = video.videoHeight; const rVid = vW / vH; const rBase = BASE_WIDTH / BASE_HEIGHT;
            let sW, sH, sX, sY; if (rVid > rBase) { sH = vH; sW = vH * rBase; sX = (vW - sW) / 2; sY = 0; } else { sW = vW; sH = vW / rBase; sX = 0; sY = (vH - sH) / 2; }
            ctx.save(); if (currentFacingMode === 'user') { ctx.translate(canvas.width, 0); ctx.scale(-1, 1); }
            ctx.drawImage(video, sX, sY, sW, sH, 0, 0, BASE_WIDTH, BASE_HEIGHT); ctx.restore();
            preview.src = canvas.toDataURL('image/png'); abrirEdicao();
        }
        function uploadGaleria(event) { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { preview.src = e.target.result; iniciarModoCrop(); }; reader.readAsDataURL(file); } }

        function iniciarModoCrop() { isCroppingMode = true; video.style.display = 'none'; preview.style.display = 'block'; iosControls.style.display = 'none'; cropControls.style.display = 'flex'; preview.classList.add('cropping-mode'); cropScale = 1; cropTranslateX = 0; cropTranslateY = 0; cropZoomSlider.value = 1; aplicarTransformCrop(); preview.addEventListener('mousedown', dragCropStart); preview.addEventListener('touchstart', dragCropStart, {passive: false}); }
        function atualizarZoomCrop(val) { cropScale = parseFloat(val); aplicarTransformCrop(); }
        function aplicarTransformCrop() { preview.style.transform = `translate(calc(0px + ${cropTranslateX}px), calc(0px + ${cropTranslateY}px)) scale(${cropScale})`; }
        function dragCropStart(e) { if(!isCroppingMode) return; e.preventDefault(); isDraggingCrop = true; startDragCropX = e.touches ? e.touches[0].clientX : e.clientX; startDragCropY = e.touches ? e.touches[0].clientY : e.clientY; }
        function dragCropMove(e) { if(!isDraggingCrop || !isCroppingMode) return; e.preventDefault(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; cropTranslateX += (clientX - startDragCropX); cropTranslateY += (clientY - startDragCropY); startDragCropX = clientX; startDragCropY = clientY; aplicarTransformCrop(); }
        function dragCropEnd() { isDraggingCrop = false; }
        window.addEventListener('mousemove', dragCropMove); window.addEventListener('touchmove', dragCropMove, {passive: false}); window.addEventListener('mouseup', dragCropEnd); window.addEventListener('touchend', dragCropEnd);
        function cancelarCrop() { isCroppingMode = false; preview.classList.remove('cropping-mode'); preview.style.transform = ''; resetar(); }
        async function confirmarCrop() {
            const canvas = document.createElement('canvas'); canvas.width = BASE_WIDTH; canvas.height = BASE_HEIGHT; const ctx = canvas.getContext('2d');
            const img = new Image(); img.src = preview.src; await imgLoad(img);
            const pW = palco.clientWidth; const scaleFactor = canvas.width / pW; const centerX = canvas.width / 2; const centerY = canvas.height / 2;
            ctx.save(); ctx.translate(centerX, centerY); ctx.translate(cropTranslateX * scaleFactor, cropTranslateY * scaleFactor); ctx.scale(cropScale, cropScale);
            const ratioImg = img.width / img.height; const ratioCanvas = canvas.width / canvas.height; let drawW, drawH;
            if (ratioImg > ratioCanvas) { drawW = canvas.width; drawH = drawW / ratioImg; } else { drawH = canvas.height; drawW = drawH * ratioImg; }
            ctx.drawImage(img, -drawW/2, -drawH/2, drawW, drawH); ctx.restore();
            preview.src = canvas.toDataURL('image/png'); isCroppingMode = false; preview.classList.remove('cropping-mode'); preview.style.transform = ''; cropControls.style.display = 'none'; preview.removeEventListener('mousedown', dragCropStart); preview.removeEventListener('touchstart', dragCropStart); abrirEdicao();
        }

        // --- STICKERS ---
        function carregarCatalogoHibrido() { listaJoias.innerHTML = ''; const pasta = 'joias/'; for (let i = 1; i <= 100; i++) { criarThumb(pasta + 'joia' + i + '.png'); } backupJoias.forEach(url => criarThumb(url)); }
        function criarThumb(url) { const img = new Image(); img.src = url; img.crossOrigin = "anonymous"; img.onload = function() { const div = document.createElement('div'); div.className = 'thumb-joia'; div.classList.add('loaded'); div.appendChild(img); div.onclick = () => adicionarSticker(url); listaJoias.appendChild(div); }; }
        function abrirEdicao() { video.style.display = 'none'; preview.style.display = 'block'; iosControls.style.display = 'none'; cropControls.style.display = 'none'; preview.classList.remove('cropping-mode'); painel.style.display = 'flex'; setTimeout(() => { painel.classList.remove('minimized'); iconToggle.innerText = 'expand_more'; }, 50); }
        function resetar() { isCroppingMode = false; video.style.display = 'block'; preview.style.display = 'none'; preview.classList.remove('cropping-mode'); preview.style.transform = ''; document.querySelectorAll('.sticker-joia').forEach(el => el.remove()); stickerAtivo = null; iosControls.style.display = 'grid'; cropControls.style.display = 'none'; painel.style.display = 'none'; document.getElementById('fileInput').value = ""; btnFinalizar.classList.remove('loading'); }
        function togglePainel() { if (painel.classList.contains('minimized')) { painel.classList.remove('minimized'); iconToggle.innerText = 'expand_more'; } else { painel.classList.add('minimized'); iconToggle.innerText = 'expand_less'; } }
        function adicionarSticker(url) { const img = document.createElement('img'); img.src = url; img.className = 'sticker-joia'; img.crossOrigin = "anonymous"; img.dataset.scale = 120; img.dataset.rotation = 0; img.style.left = (palco.clientWidth / 2) + 'px'; img.style.top = (palco.clientHeight / 2) + 'px'; img.style.transform = `translate(-50%, -50%) rotate(0deg)`; img.style.width = '120px'; img.addEventListener('touchstart', dragStickerStart, {passive: false}); img.addEventListener('mousedown', dragStickerStart); img.addEventListener('click', (e) => { e.stopPropagation(); definirAtivo(img); }); palco.appendChild(img); definirAtivo(img); }
        function definirAtivo(el) { if(stickerAtivo) stickerAtivo.classList.remove('selected'); stickerAtivo = el; stickerAtivo.classList.add('selected'); rangeSize.value = stickerAtivo.dataset.scale; rangeRotate.value = stickerAtivo.dataset.rotation; }
        function removerStickerAtivo() { if(stickerAtivo) { stickerAtivo.remove(); stickerAtivo = null; } }
        function ajustarStickerAtivo() { if(!stickerAtivo) return; const scale = rangeSize.value; const rotation = rangeRotate.value; stickerAtivo.dataset.scale = scale; stickerAtivo.dataset.rotation = rotation; stickerAtivo.style.width = `${scale}px`; stickerAtivo.style.transform = `translate(-50%, -50%) rotate(${rotation}deg)`; }
        let isDraggingSticker = false; let dragStickerOffsetX, dragStickerOffsetY;
        function dragStickerStart(e) { if(!e.target.classList.contains('sticker-joia')) return; e.preventDefault(); isDraggingSticker = true; definirAtivo(e.target); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; const rect = palco.getBoundingClientRect(); const currentLeft = parseFloat(stickerAtivo.style.left || 0); const currentTop = parseFloat(stickerAtivo.style.top || 0); dragStickerOffsetX = clientX - (rect.left + currentLeft); dragStickerOffsetY = clientY - (rect.top + currentTop); }
        function dragStickerMove(e) { if (!isDraggingSticker || !stickerAtivo) return; e.preventDefault(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; const rect = palco.getBoundingClientRect(); let newLeft = clientX - rect.left - dragStickerOffsetX; let newTop = clientY - rect.top - dragStickerOffsetY; stickerAtivo.style.left = newLeft + 'px'; stickerAtivo.style.top = newTop + 'px'; }
        function dragStickerEnd() { isDraggingSticker = false; }
        window.addEventListener('touchmove', dragStickerMove, {passive: false}); window.addEventListener('mousemove', dragStickerMove); window.addEventListener('touchend', dragStickerEnd); window.addEventListener('mouseup', dragStickerEnd);

        // --- GERAÇÃO DA POLAROIDE (DESIGN FINAL) ---
        async function desenharCenaNoCanvas(canvas) {
            const ctx = canvas.getContext('2d'); 
            const CW = canvas.width; const CH = canvas.height;
            
            // 1. Fundo Degradê Verde
            const grad = ctx.createLinearGradient(0, 0, 0, CH);
            grad.addColorStop(0, "#0B464C");
            grad.addColorStop(1, "#206870");
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, CW, CH);
            
            // 2. Papel Branco da Polaroid (Sem Sombra de Fundo)
            const paperMarginSide = 50; const paperMarginTop = 100; const paperMarginBottom = 100;
            const paperW = CW - (paperMarginSide * 2); const paperH = CH - paperMarginTop - paperMarginBottom;
            const paperX = paperMarginSide; const paperY = paperMarginTop;

            ctx.save();
            ctx.fillStyle = "#ffffff"; ctx.fillRect(paperX, paperY, paperW, paperH);
            ctx.restore();

            // 3. Área da Foto
            const photoInnerMargin = 30; const photoBottomArea = 350;
            const photoAreaW = paperW - (photoInnerMargin * 2); const photoAreaH = paperH - photoInnerMargin - photoBottomArea;
            const photoAreaX = paperX + photoInnerMargin; const photoAreaY = paperY + photoInnerMargin;

            const imgBase = new Image(); imgBase.src = preview.src; await imgLoad(imgBase);
            
            ctx.save(); ctx.beginPath(); ctx.rect(photoAreaX, photoAreaY, photoAreaW, photoAreaH); ctx.clip();
            const imgRatio = imgBase.width / imgBase.height; const targetRatio = photoAreaW / photoAreaH;
            let drawW, drawH, drawX, drawY;
            if (imgRatio > targetRatio) { drawH = photoAreaH; drawW = photoAreaH * imgRatio; drawY = photoAreaY; drawX = photoAreaX + (photoAreaW - drawW)/2; } 
            else { drawW = photoAreaW; drawH = photoAreaW / imgRatio; drawX = photoAreaX; drawY = photoAreaY + (photoAreaH - drawH)/2; }
            ctx.drawImage(imgBase, drawX, drawY, drawW, drawH);
            ctx.restore();

            // 4. Stickers
            const palcoW = palco.clientWidth; const palcoH = palco.clientHeight;
            const stickers = document.querySelectorAll('.sticker-joia');
            for(let s of stickers) {
                const imgS = new Image(); imgS.crossOrigin = "anonymous"; imgS.src = s.src; await imgLoad(imgS);
                const relX = parseFloat(s.style.left) / palcoW; const relY = parseFloat(s.style.top) / palcoH;
                const canvasX = drawX + (relX * drawW); const canvasY = drawY + (relY * drawH);
                const sScale = parseFloat(s.dataset.scale); const scaleFactor = drawW / palcoW; 
                const finalW = sScale * scaleFactor; const ratio = imgS.height / imgS.width;
                ctx.save(); 
                ctx.beginPath(); ctx.rect(photoAreaX, photoAreaY, photoAreaW, photoAreaH); ctx.clip();
                ctx.translate(canvasX, canvasY); 
                ctx.rotate(parseFloat(s.dataset.rotation) * Math.PI / 180);
                ctx.drawImage(imgS, -finalW/2, -(finalW*ratio)/2, finalW, finalW*ratio); 
                ctx.restore();
            }

            // 5. Logo e Texto Retos (Sem rotação)
            try {
                const logo = new Image(); logo.src = "logo-preto-dark.png"; await imgLoad(logo);
                const lW = 250; 
                const lH = lW * (logo.height / logo.width);
                const anchorX = paperX + paperW - 40; const anchorY = paperY + paperH - 40;

                ctx.save();
                ctx.translate(anchorX, anchorY);
                // RETO (sem rotate)
                ctx.drawImage(logo, -lW, -lH - 45, lW, lH);
                ctx.font = "bold 30px Raleway"; ctx.fillStyle = "#333"; ctx.textAlign = "right"; 
                ctx.fillText("@orelhadossonhosrp", 0, 0);
                ctx.restore();
            } catch(e) { console.log(e); }
        }

        async function animarImpressao() {
            if(stickerAtivo) stickerAtivo.classList.remove('selected');
            btnFinalizar.classList.add('loading');
            try {
                const canvas = document.createElement('canvas'); canvas.width = 1080; canvas.height = 1920;
                await desenharCenaNoCanvas(canvas);
                canvas.toBlob((blob) => {
                    blobFinal = blob; finalPolaroidImage.src = URL.createObjectURL(blob);
                    appContainer.style.opacity = '0';
                    setTimeout(() => {
                        appContainer.style.display = 'none'; impressoraOverlay.style.display = 'flex';
                        setTimeout(() => {
                            photoResult.classList.add('printing-animation');
                            setTimeout(() => { btnShareFinal.classList.add('visible'); }, 5500); 
                        }, 100);
                    }, 800);
                }, 'image/png');
            } catch (e) { alert("Erro ao processar imagem."); btnFinalizar.classList.remove('loading'); }
        }

        async function compartilharResultado() {
            if (!blobFinal) return;
            const file = new File([blobFinal], "orelha-polaroid.png", { type: "image/png" });
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                try { await navigator.share({ files: [file], title: 'Minha Orelha dos Sonhos', text: 'Olha meu teste virtual!' }); } catch (err) {}
            } else {
                const link = document.createElement('a'); link.download = 'orelha-polaroid.png'; link.href = URL.createObjectURL(blobFinal); link.click(); alert("Imagem salva na galeria!");
            }
        }
        function imgLoad(img) { return new Promise((resolve) => { if (img.complete) return resolve(); img.onload = resolve; img.onerror = resolve; }); }
    </script>
</body>
</html>