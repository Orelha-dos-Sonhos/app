<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Orelha dos Sonhos</title>
    
    <link rel="icon" type="image/png" href="icon-web.png">
    <link rel="apple-touch-icon" href="icon-web.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Raleway:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --texto-escuro: #333333;
            --fonte-titulo: 'Playfair Display', serif;
            --fonte-ui: 'Raleway', sans-serif;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--fonte-ui); color: var(--texto-escuro);
            height: 100vh; height: 100dvh; width: 100vw; overflow: hidden;
            display: flex; flex-direction: column; align-items: center;
            
            /* BACKGROUND PASTEL */
            background: linear-gradient(-45deg, #ffd1dc, #c8e6c9, #ffcdd2, #b2dfdb, #f8bbd0);
            background-size: 300% 300%; animation: gradientBG 10s ease infinite;
            
            padding-top: var(--safe-top);
            padding-bottom: 0; /* Remove padding inferior fixo para layout dinâmico */
        }

        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* --- ESTRUTURA FLEXÍVEL PRINCIPAL --- */
        #app-container {
            width: 100%; max-width: 600px; height: 100%;
            display: flex; flex-direction: column; /* Pilha vertical */
            position: relative;
        }

        /* 1. HEADER (Não é mais absolute) */
        header { 
            padding: 10px; width: 100%; text-align: center; z-index: 10; flex-shrink: 0;
            background: transparent;
        }
        .logo-img { max-height: 80px; width: auto; display: block; margin: 0 auto; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.1)); }

        /* 2. ÁREA DA CÂMERA (Cresce para ocupar espaço) */
        #container-palco { 
            flex: 1; /* O segredo: ocupa todo o espaço sobrando */
            display: flex; justify-content: center; align-items: center; 
            padding: 10px 20px; /* Margem lateral para não colar na borda */
            position: relative; overflow: hidden;
            transition: all 0.4s ease; /* Animação suave ao redimensionar */
        }
        
        #palco {
            /* Tamanho responsivo mantendo proporção */
            height: 100%; 
            max-width: 100%;
            aspect-ratio: 3/4; /* Formato Retrato Fixo */
            
            background: #000; border-radius: 25px; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 4px solid rgba(255,255,255,0.9); 
            position: relative; touch-action: none; user-select: none;
            transition: all 0.4s ease;
        }

        video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        #previewImage { width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0; background: #000; }
        .mirrored { transform: scaleX(-1); }

        .sticker-joia {
            position: absolute; width: 120px; top: 50%; left: 50%;
            transform-origin: center center; cursor: grab;
            filter: drop-shadow(2px 5px 8px rgba(0,0,0,0.4)); z-index: 15;
        }
        .sticker-joia.selected { border: 2px dashed rgba(255,255,255,0.9); }

        /* CONTROLES DA CÂMERA (Flutuantes dentro do palco ou sobre ele) */
        .ios-controls {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 320px; 
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 20px; border-radius: 40px; 
            display: grid; grid-template-columns: 1fr auto 1fr;
            align-items: center; justify-items: center; z-index: 30;
        }
        .shutter-button { width: 65px; height: 65px; border-radius: 50%; border: 4px solid white; background: transparent; padding: 3px; cursor: pointer; }
        .shutter-button::after { content: ''; display: block; width: 100%; height: 100%; background: white; border-radius: 50%; }
        .mini-btn { color: #fff; background: transparent; border: none; font-size: 0.6rem; text-transform: uppercase; cursor: pointer; display: flex; flex-direction: column; align-items: center; opacity: 0.9; }
        .mini-btn i { font-size: 28px; margin-bottom: 2px; }

        /* 3. PAINEL DE EDIÇÃO (Rodapé Dinâmico) */
        #painel-edicao {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-top: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 30px 30px 0 0; 
            
            /* Layout Flex Column */
            display: none; /* Começa oculto */
            flex-direction: column; 
            z-index: 50; 
            box-shadow: 0 -5px 30px rgba(0,0,0,0.1);
            
            /* Transição de Altura */
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            overflow: hidden; /* Esconde o conteúdo ao minimizar */
            
            /* Padding inferior seguro para iPhones */
            padding-bottom: calc(15px + var(--safe-bottom));
            flex-shrink: 0; /* Não encolhe além do definido */
        }

        /* Classes de Estado do Painel */
        #painel-edicao.expanded {
            height: auto;
            padding-top: 15px; padding-left: 20px; padding-right: 20px;
        }

        #painel-edicao.minimized {
            height: 60px; /* Altura apenas do cabeçalho */
            padding-top: 10px; padding-left: 20px; padding-right: 20px;
            background: rgba(255, 255, 255, 0.8);
        }

        /* Conteúdo que some ao minimizar */
        #painel-edicao.minimized .conteudo-ocultavel {
            opacity: 0; pointer-events: none; height: 0; margin: 0;
        }
        
        .conteudo-ocultavel {
            opacity: 1; transition: opacity 0.2s;
            display: flex; flex-direction: column; gap: 12px;
        }

        /* Cabeçalho do Painel (Sempre visível) */
        .header-edicao { 
            display: flex; justify-content: space-between; align-items: center; 
            height: 40px; cursor: pointer;
        }
        
        .titulo-wrapper { display: flex; align-items: center; gap: 10px; }
        .titulo-edicao { font-weight: 800; color: var(--texto-escuro); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .btn-toggle { background: transparent; border: none; color: #555; cursor: pointer; display: flex; align-items: center; }
        
        .carrossel { display: flex; overflow-x: auto; gap: 10px; padding: 5px; min-height: 75px; -webkit-overflow-scrolling: touch; }
        .thumb-joia {
            flex-shrink: 0; width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.8);
            border: 2px solid #fff; padding: 5px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; display: none; transition: transform 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .thumb-joia.loaded { display: flex; }
        .thumb-joia.active { border-color: var(--menta-forte); transform: scale(1.1); background: #fff; }
        .thumb-joia img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }

        .ferramentas-ajuste { display: flex; gap: 10px; align-items: center; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 15px; }
        .slider-row { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .slider-label { font-size: 0.6rem; font-weight: 800; text-transform: uppercase; color: #555; }
        input[type=range] { width: 100%; accent-color: #333; height: 4px; cursor: pointer; }

        .btn-trash {
            width: 35px; height: 35px; border-radius: 50%; border: none;
            background: #ff5252; color: white; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(255, 82, 82, 0.3); cursor: pointer;
        }

        .acoes-finais { display: flex; gap: 10px; width: 100%; margin-top: 5px; }
        
        .btn-final {
            background: rgba(255, 255, 255, 0.6); border: 1px solid rgba(255, 255, 255, 0.8);
            color: var(--texto-escuro); border-radius: 50px; flex: 1; padding: 14px;
            font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.75rem;
            display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: background 0.2s;
        }
        .btn-final:active { transform: scale(0.98); background: rgba(255,255,255,0.9); }
        .btn-final.loading::after { content: ""; width: 15px; height: 15px; border: 2px solid currentColor; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .btn-voltar-edicao { background: rgba(0,0,0,0.05); border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #fileInput { display: none; }

        /* Menu Principal (Só aparece no modo câmera) */
        .menu-footer { 
            padding: 10px 15px calc(20px + var(--safe-bottom)) 15px; width: 100%;
            display: flex; justify-content: center; gap: 10px; z-index: 40; 
            background: transparent; flex-shrink: 0;
        }
        .btn-menu-glow {
            background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 20px; padding: 14px 2px; flex: 1; min-width: 0;
            color: #333; text-align: center; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; 
            text-decoration: none; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

    </style>
</head>
<body>

    <div id="app-container">
        
        <header>
            <img src="logo-branco-brilho.png" alt="Orelha dos Sonhos" class="logo-img">
        </header>

        <div id="container-palco">
            <div id="palco">
                <video id="videoElement" autoplay playsinline class="mirrored"></video>
                <img id="previewImage" style="display:none;" crossorigin="anonymous">
                
                <div id="ios-controls" class="ios-controls">
                    <button class="mini-btn" onclick="document.getElementById('fileInput').click()" title="Galeria">
                        <i class="material-icons">photo_library</i>
                    </button>
                    <input type="file" id="fileInput" accept="image/*" onchange="uploadGaleria(event)">
                    
                    <button class="shutter-button" onclick="capturarFoto()"></button>
                    
                    <button class="mini-btn" onclick="alternarCamera()" title="Trocar Câmera">
                        <i class="material-icons">flip_camera_ios</i>
                    </button>
                </div>
            </div>
        </div>

        <div id="painel-edicao" class="expanded">
            <div class="header-edicao">
                <div class="titulo-wrapper" onclick="togglePainel()">
                    <button class="btn-toggle"><i class="material-icons" id="iconToggle">expand_more</i></button>
                    <span class="titulo-edicao">Personalizar</span>
                </div>
                <button class="btn-voltar-edicao" onclick="resetar()"><i class="material-icons">close</i></button>
            </div>
            
            <div class="conteudo-ocultavel">
                <div class="carrossel" id="listaJoias"></div>
                
                <div class="ferramentas-ajuste">
                    <div class="slider-row">
                        <div class="slider-label">Tamanho</div>
                        <input type="range" min="30" max="400" value="120" id="rangeSize" oninput="ajustarStickerAtivo()">
                    </div>
                    <div class="slider-row">
                        <div class="slider-label">Rotação</div>
                        <input type="range" min="-180" max="180" value="0" id="rangeRotate" oninput="ajustarStickerAtivo()">
                    </div>
                    <button class="btn-trash" onclick="removerStickerAtivo()" title="Remover">
                        <i class="material-icons">delete</i>
                    </button>
                </div>
                
                <div class="acoes-finais">
                    <button class="btn-final" id="btnSave" onclick="salvarSemMoldura()">
                        <span>Baixar</span> <i class="material-icons">download</i>
                    </button>
                    <button class="btn-final" id="btnShare" onclick="gerarPolaroideFinal()">
                        <span>Postar</span> <i class="material-icons">ios_share</i>
                    </button>
                </div>
            </div>
        </div>

        <div id="menu-footer" class="menu-footer">
            <a href="agendamento.html" class="btn-menu-glow">Agendamento</a>
            <a href="contato.html" class="btn-menu-glow">Contato</a>
            <a href="joias.html" class="btn-menu-glow">Joias</a>
            <a href="cuidados.html" class="btn-menu-glow">Cuidados</a>
        </div>

    </div>

    <script>
        const video = document.getElementById('videoElement');
        const preview = document.getElementById('previewImage');
        const palco = document.getElementById('palco');
        const listaJoias = document.getElementById('listaJoias');
        const rangeSize = document.getElementById('rangeSize');
        const rangeRotate = document.getElementById('rangeRotate');
        const btnShare = document.getElementById('btnShare');
        const btnSave = document.getElementById('btnSave');
        const painel = document.getElementById('painel-edicao');
        const iconToggle = document.getElementById('iconToggle');

        let stickerAtivo = null;
        let currentFacingMode = 'user'; 
        let currentStream = null;

        const backupJoias = [
            "https://i.imgur.com/4q6kL6A.png", "https://i.imgur.com/Hze2y0j.png", "https://i.imgur.com/Pk7fW9M.png"
        ];

        window.onload = () => { startCamera(); carregarCatalogoHibrido(); }

        async function startCamera() {
            if (currentStream) currentStream.getTracks().forEach(track => track.stop());
            const constraints = { video: { facingMode: currentFacingMode, width: { ideal: 1920 }, height: { ideal: 1080 } } };
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream; video.srcObject = stream;
                if (currentFacingMode === 'user') video.classList.add('mirrored');
                else video.classList.remove('mirrored');
            } catch (err) {
                try {
                    const streamPC = await navigator.mediaDevices.getUserMedia({ video: true });
                    currentStream = streamPC; video.srcObject = streamPC; video.classList.add('mirrored'); 
                } catch(e) {}
            }
        }

        function alternarCamera() {
            currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
            startCamera();
        }

        function capturarFoto() {
            const canvas = document.createElement('canvas');
            const vW = video.videoWidth; const vH = video.videoHeight;
            const pW = palco.clientWidth; const pH = palco.clientHeight;
            
            // Alta resolução 3:4
            canvas.width = 1080;
            canvas.height = 1080 * (pH / pW); 

            const ctx = canvas.getContext('2d');
            const rVid = vW / vH; const rCan = canvas.width / canvas.height;
            let sW, sH, sX, sY;

            if (rVid > rCan) { sH = vH; sW = vH * rCan; sX = (vW - sW) / 2; sY = 0; } 
            else { sW = vW; sH = vW / rCan; sX = 0; sY = (vH - sH) / 2; }

            ctx.save();
            if (currentFacingMode === 'user') { ctx.translate(canvas.width, 0); ctx.scale(-1, 1); }
            ctx.drawImage(video, sX, sY, sW, sH, 0, 0, canvas.width, canvas.height);
            ctx.restore();

            preview.src = canvas.toDataURL('image/png');
            abrirEdicao();
        }

        function uploadGaleria(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { preview.src = e.target.result; abrirEdicao(); }
                reader.readAsDataURL(file);
            }
        }

        function carregarCatalogoHibrido() {
            listaJoias.innerHTML = '';
            const pasta = 'joias/';
            for (let i = 1; i <= 100; i++) { criarThumb(pasta + 'joia' + i + '.png'); }
            backupJoias.forEach(url => criarThumb(url));
        }

        function criarThumb(url) {
            const img = new Image(); img.src = url; img.crossOrigin = "anonymous";
            img.onload = function() {
                const div = document.createElement('div'); div.className = 'thumb-joia'; div.classList.add('loaded');
                div.appendChild(img); div.onclick = () => adicionarSticker(url);
                listaJoias.appendChild(div);
            };
        }

        function abrirEdicao() {
            video.style.display = 'none'; preview.style.display = 'block';
            document.getElementById('ios-controls').style.display = 'none';
            document.getElementById('menu-footer').style.display = 'none';
            
            painel.style.display = 'flex';
            // Garante que comece expandido
            painel.classList.remove('minimized');
            painel.classList.add('expanded');
            iconToggle.innerText = 'expand_more';
        }

        function resetar() {
            video.style.display = 'block'; preview.style.display = 'none';
            document.querySelectorAll('.sticker-joia').forEach(el => el.remove()); stickerAtivo = null;
            document.getElementById('ios-controls').style.display = 'grid';
            document.getElementById('menu-footer').style.display = 'flex';
            
            painel.style.display = 'none';
            document.getElementById('fileInput').value = "";
            btnShare.classList.remove('loading'); btnSave.classList.remove('loading');
        }

        function togglePainel() {
            if (painel.classList.contains('minimized')) {
                painel.classList.remove('minimized');
                painel.classList.add('expanded');
                iconToggle.innerText = 'expand_more';
            } else {
                painel.classList.remove('expanded');
                painel.classList.add('minimized');
                iconToggle.innerText = 'expand_less';
            }
        }

        function adicionarSticker(url) {
            const img = document.createElement('img'); img.src = url; img.className = 'sticker-joia'; img.crossOrigin = "anonymous";
            img.dataset.scale = 120; img.dataset.rotation = 0; img.dataset.x = 0; img.dataset.y = 0;
            img.style.width = '120px'; img.style.transform = `translate(-50%, -50%)`;
            img.addEventListener('touchstart', dragStart, {passive: false}); img.addEventListener('mousedown', dragStart);
            img.addEventListener('click', (e) => { e.stopPropagation(); definirAtivo(img); });
            palco.appendChild(img); definirAtivo(img);
        }

        function definirAtivo(el) {
            if(stickerAtivo) stickerAtivo.classList.remove('selected');
            stickerAtivo = el; stickerAtivo.classList.add('selected');
            rangeSize.value = stickerAtivo.dataset.scale; rangeRotate.value = stickerAtivo.dataset.rotation;
        }

        function removerStickerAtivo() {
            if(stickerAtivo) { stickerAtivo.remove(); stickerAtivo = null; }
        }

        function ajustarStickerAtivo() {
            if(!stickerAtivo) return;
            const scale = rangeSize.value; const rotation = rangeRotate.value;
            const x = parseFloat(stickerAtivo.dataset.x); const y = parseFloat(stickerAtivo.dataset.y);
            stickerAtivo.dataset.scale = scale; stickerAtivo.dataset.rotation = rotation;
            stickerAtivo.style.width = `${scale}px`;
            stickerAtivo.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) rotate(${rotation}deg)`;
        }

        let isDragging = false; let startX, startY, initialObjX, initialObjY;
        function dragStart(e) {
            if(!e.target.classList.contains('sticker-joia')) return;
            e.preventDefault(); isDragging = true; definirAtivo(e.target);
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            startX = clientX; startY = clientY;
            initialObjX = parseFloat(stickerAtivo.dataset.x); initialObjY = parseFloat(stickerAtivo.dataset.y);
        }
        function dragMove(e) {
            if (!isDragging || !stickerAtivo) return; e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const deltaX = clientX - startX; const deltaY = clientY - startY;
            stickerAtivo.dataset.x = initialObjX + deltaX; stickerAtivo.dataset.y = initialObjY + deltaY;
            ajustarStickerAtivo();
        }
        function dragEnd() { isDragging = false; }
        window.addEventListener('touchmove', dragMove, {passive: false}); window.addEventListener('mousemove', dragMove);
        window.addEventListener('touchend', dragEnd); window.addEventListener('mouseup', dragEnd);

        async function desenharCenaNoCanvas(canvas, comMoldura) {
            const ctx = canvas.getContext('2d'); const CW = canvas.width; const CH = canvas.height;
            let photoX, photoY, photoW, photoH;

            if (comMoldura) {
                const gradient = ctx.createLinearGradient(0, 0, CW, CH);
                gradient.addColorStop(0, "#ffd1dc"); gradient.addColorStop(0.5, "#c8e6c9"); gradient.addColorStop(1, "#b2dfdb");
                ctx.fillStyle = gradient; ctx.fillRect(0, 0, CW, CH);
                const margin = 80; const paperW = CW - margin*2; const paperH = 1600; const paperX = margin; const paperY = (CH - paperH)/2 - 50;
                ctx.fillStyle = "#fff"; ctx.shadowColor = "rgba(0,0,0,0.2)"; ctx.shadowBlur = 30;
                ctx.fillRect(paperX, paperY, paperW, paperH); ctx.shadowColor = "transparent";
                const photoMargin = 50;
                photoX = paperX + photoMargin; photoY = paperY + photoMargin;
                photoW = paperW - photoMargin*2; photoH = photoW * 1.33; 
            } else {
                photoX = 0; photoY = 0; photoW = CW; photoH = CH;
            }

            const imgBase = new Image(); imgBase.src = preview.src; await imgLoad(imgBase);
            ctx.save(); ctx.beginPath(); ctx.rect(photoX, photoY, photoW, photoH); ctx.clip();
            const rImg = imgBase.width/imgBase.height; const rArea = photoW/photoH; let dw, dh, dx, dy;
            if(rImg > rArea) { dh = photoH; dw = imgBase.width*(photoH/imgBase.height); dx = photoX-(dw-photoW)/2; dy = photoY; }
            else { dw = photoW; dh = imgBase.height*(photoW/imgBase.width); dx = photoX; dy = photoY-(dh-photoH)/2; }
            ctx.drawImage(imgBase, dx, dy, dw, dh);

            const stickers = document.querySelectorAll('.sticker-joia');
            const palcoRect = palco.getBoundingClientRect(); const scaleFactor = photoW / palcoRect.width;
            const centerX = photoX + photoW/2; const centerY = photoY + photoH/2;
            for(let s of stickers) {
                const imgS = new Image(); imgS.crossOrigin = "anonymous"; imgS.src = s.src; await imgLoad(imgS);
                const sX = parseFloat(s.dataset.x); const sY = parseFloat(s.dataset.y);
                const sScale = parseFloat(s.dataset.scale); const sRot = parseFloat(s.dataset.rotation);
                const finalX = centerX + (sX * scaleFactor); const finalY = centerY + (sY * scaleFactor);
                const finalW = sScale * scaleFactor; const ratio = imgS.height / imgS.width;
                ctx.save(); ctx.translate(finalX, finalY); ctx.rotate(sRot * Math.PI / 180);
                ctx.drawImage(imgS, -finalW/2, -(finalW*ratio)/2, finalW, finalW*ratio); ctx.restore();
            }
            ctx.restore();

            if (comMoldura) {
                try {
                    const logo = new Image(); logo.src = "logo-branco-brilho.png"; await imgLoad(logo);
                    const lW = 150; const lH = lW*(logo.height/logo.width); 
                    const paperRight = (80 + (CW - 160)); 
                    const paperBottom = ((CH - 1600)/2 - 50) + 1600;
                    const lX = paperRight - lW - 40; const lY = paperBottom - lH - 40;
                    ctx.shadowColor = "#333"; ctx.shadowBlur = 5; ctx.filter = "brightness(0.3)";
                    ctx.drawImage(logo, lX, lY, lW, lH); ctx.filter = "none"; ctx.shadowColor = "transparent";
                    ctx.font = "bold 24px Raleway"; ctx.fillStyle = "#666"; ctx.textAlign = "right";
                    ctx.fillText("@orelhadossonhosrp", lX + lW + 10, lY - 15);
                } catch(e) {}
            }
        }

        async function salvarSemMoldura() {
            if(stickerAtivo) stickerAtivo.classList.remove('selected');
            btnSave.classList.add('loading');
            try {
                const canvas = document.createElement('canvas');
                canvas.width = 1080; canvas.height = 1440; 
                await desenharCenaNoCanvas(canvas, false);
                const link = document.createElement('a'); link.download = 'minha-orelha.png';
                link.href = canvas.toDataURL(); link.click();
                btnSave.classList.remove('loading');
            } catch (e) { alert("Erro ao salvar"); btnSave.classList.remove('loading'); }
        }

        async function gerarPolaroideFinal() {
            if(stickerAtivo) stickerAtivo.classList.remove('selected');
            btnShare.classList.add('loading');
            try {
                const canvas = document.createElement('canvas'); canvas.width = 1080; canvas.height = 1920;
                await desenharCenaNoCanvas(canvas, true);
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], "orelha-polaroid.png", { type: "image/png" });
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        try { await navigator.share({ files: [file], title: 'Orelha dos Sonhos' }); } catch (err) {}
                    } else {
                        const link = document.createElement('a'); link.download = 'orelha-polaroid.png'; link.href = canvas.toDataURL(); link.click();
                    }
                    btnShare.classList.remove('loading');
                }, 'image/png');
            } catch (error) { alert("Erro ao criar imagem."); btnShare.classList.remove('loading'); }
        }

        function imgLoad(img) { return new Promise((resolve) => { if (img.complete) return resolve(); img.onload = resolve; img.onerror = resolve; }); }
    </script>
</body>
</html>